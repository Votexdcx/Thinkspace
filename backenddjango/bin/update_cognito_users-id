#!/usr/bin/env python3
import boto3
import os
import json
from psycopg_pool import ConnectionPool

connection_url = os.getenv("CONNECTION_URL")
pool = ConnectionPool("postgresql://Thinkspacedb:quwrem-firjyz-vipmA7@thinkspace.c32ye0guaums.eu-west-2.rds.amazonaws.com:5432/thinkspace")


def updateCognitousersid(handle,sub):
    print(handle, sub)
    sql=("""
           UPDATE public.users
           SET cognito_user_id = %(sub)s
           WHERE display_name = %(handle)s
        """)
    with pool.connection() as conn:
        with conn.cursor() as cur:
            cur.execute(sql,{
                'handle': handle,
                'sub': sub
            })

def Cognitogetusersid():
    user_poolID = "eu-west-2_uhta1UGB8"
    client = boto3.client("cognito-idp")

    params = {
        'UserPoolId': user_poolID,
        'AttributesToGet':[
            'preferred_username',
            'sub'
        ]
    }
    response = client.list_users(**params)
    users = response['Users']
    #print (json. dumps (users, sort_keys=True, indent=2, default=str))
    dict_users = {

    }
    for user in users:
        print(user)
        #print (json. dumps (user, sort_keys=True, indent=2, default=str))
        sub = next(attr["Value"] for attr in user["Attributes"] if attr["Name"] == "sub"),None
        handle = next(attr["Value"] for attr in user["Attributes"] if attr["Name"] == "preferred_username"),None
        dict_users[handle[0]] = sub[0]
        print(dict_users)
    return dict_users


users  = Cognitogetusersid()
print(users)
for handle,sub in users.items():
    updateCognitousersid(handle,sub)